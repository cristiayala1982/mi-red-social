<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <title>Home</title>
  <link rel="stylesheet" href="home-css/navbar.css">
  <link rel="stylesheet" href="home-css/panelChats.css">
  <link rel="stylesheet" href="home-css/modal-listaamigos.css">
  <link rel="stylesheet" href="home-css/chats.css">
  
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
</head>

<body>
<nav class="app-navbar">
  <div class="app-navbar-logo">
    <a href="home.html">
      <img src="img/icono home.webp" alt="Inicio" class="logo-img">
    </a>
  </div>

  <form id="form-busqueda" class="buscador-usuarios">
    <button type="button" class="btn-cerrar-busqueda mobile-only">‚úï</button>
    <span class="icono-lupa">üîç</span>
    <input type="text" id="input-busqueda" placeholder="Buscar usuario..." autocomplete="off">
    <ul id="resultados-busqueda" class="resultados-autocompletado"></ul>
  </form>

  <div class="nav-right-section">
    <button class="icono-btn mobile-only" id="btn-abrir-busqueda">üîç</button>
    
    <div class="nav-icons">
      <button id="btn-amigos" class="icono-btn">üë•</button>
      <button id="btn-mensajes" class="icono-btn">
        üí¨ <span id="badge-mensajes" class="badge oculto"></span>
      </button>
    </div>

    <div class="perfil-menu">
      <img id="nav-foto-perfil" src="img/usuario-camara.png" alt="Perfil" class="perfil-icono-nav">
      <ul class="dropdown-menu">
        <li><a href="miPerfil.html">Mi perfil</a></li>
        <li><a href="#">Cerrar sesi√≥n</a></li>
      </ul>
    </div>
  </div>
</nav>
<!-- Contenedor principal de la app -->
<div class="app-container">
  <!-- MODAL AMIGOS -->
<div id="modal-amigos" class="modal-amigos">
  <div class="modal-contenido">
    <div class="modal-header">
      <h2>Lista de Amigos</h2>
      <span id="cerrar-modal-amigos" class="cerrar-modal">&times;</span>
    </div>
    <div class="modal-body">
      <ul id="lista-amigos" class="lista-amigos"></ul>
    </div>
  </div>
</div>

 <!-- Panel lateral de chats (oculto al inicio) -->
<div id="panel-chats" class="panel">
  <div class="encabezado-panel-chats">
    <span class="cerrar-panel">&times;</span>
    <span class="badge-global" id="contador-mensajes"></span>
  </div>
  <h2>Mis chats</h2>
  <ul id="lista-chats"></ul>
</div>

<main class="chat-container">
  <!-- Encabezado del chat -->
  <div class="encabezado-chat">
    <img src="img/usuario-camara.png" alt="Foto" class="foto-chat" id="foto-chat">
    <span class="nombre-chat" id="nombre-chat"></span>
    <button id="btn-borrar-chat" title="Eliminar este chat">üóëÔ∏è</button>
  </div>
  <!--NOTIFICACION DE BORRAR MENSAJE-->
  <div id="notificacion-chat" class="notificacion oculto"></div>

  <!-- Cuadro de mensajes con scroll independiente -->
  <div class="mensajes-wrapper">
    <div class="mensajes-centro">
      <ul id="lista-mensajes"></ul>
    </div>
  </div>

  <!-- Input de mensaje -->
<div class="input-container">
  <div class="input-wrapper">
    <textarea id="nuevo-mensaje" rows="1" placeholder="Escribe un mensaje..."></textarea>
    <!-- üé§ Bot√≥n micr√≥fono / stop -->
    <button id="btn-audio" class="icono-audio" title="Grabar audio">
      <i class="fa fa-microphone"></i>
    </button>
    <!-- üîä Ondas de grabaci√≥n -->
    <div id="grabando-ondas" class="ondas oculto">
      <span></span><span></span><span></span><span></span>
    </div>
  </div>
  <button id="enviar">Enviar</button>
</div>
</main>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Scripts principales en orden -->
    
    <script type="module" src="HOME_JS/navbar.js"></script>
    <script type="module" src="HOME_JS/buscador.js"></script>
    <script type="module" src="HOME_JS/cerrarSesion.js"></script>
    <script type="module" src="HOME_JS/listaAmigosYchats.js"></script>
    <script>

// --- CONFIGURACI√ìN ---
const API_URL = "https://phonic-odyssey-480319-a4.rj.r.appspot.com";
const BUCKET_NAME = "mi-red-social-imagenes"; // Aseg√∫rate de que este sea el nombre correcto de tu bucket

// --- ELEMENTOS DEL DOM ---
const listaMensajes = document.getElementById("lista-mensajes");
const btnEnviar = document.getElementById("enviar");
const nuevoMensaje = document.getElementById("nuevo-mensaje");
const btnAudio = document.getElementById("btn-audio");
const ondas = document.getElementById("grabando-ondas");
const mensajesWrapper = document.querySelector(".mensajes-wrapper");//ultimo scroll


// --- L√ìGICA DE AUDIO ---
let mediaRecorder;
let audioChunks = [];
let grabando = false;

btnAudio.addEventListener("click", async () => {
  if (!grabando) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "mensaje.webm");

        const params = new URLSearchParams(window.location.search);
        const chatId = params.get("id");

        const res = await fetch(`${API_URL}/api/chats/${chatId}/audio`, {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          cargarMensajes(chatId);
        } else {
          alert("‚ùå No se pudo enviar el audio");
        }

        btnAudio.innerHTML = `<i class="fa fa-microphone"></i>`;
        ondas.classList.add("oculto");
        grabando = false;
      };

      mediaRecorder.start();
      btnAudio.innerHTML = "‚èπÔ∏è";
      ondas.classList.remove("oculto");
      grabando = true;

      setTimeout(() => {
        if (grabando) mediaRecorder.stop();
      }, 30000);

    } catch (err) {
      console.error("‚ùå Error accediendo al micr√≥fono:", err);
      alert("No se pudo acceder al micr√≥fono");
    }
  } else {
    mediaRecorder.stop();
  }
});

// --- L√ìGICA DE MENSAJES (corregida para audio y duplicados) ---
async function cargarMensajes(chatId) {
  try {
    const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
      credentials: "include"
    });
    const data = await res.json();

    if (!data.success) {
      listaMensajes.innerHTML = "<li>Error al cargar mensajes</li>";
      return;
    }
    // Encabezado
    document.getElementById("nombre-chat").textContent = data.nombre || "";
    const fotoValida = typeof data.fotoPerfil === "string" && data.fotoPerfil.trim() !== "";
    const foto = fotoValida ? `${data.fotoPerfil}?t=${Date.now()}` : "img/usuario-camara.png";
    const fotoChat = document.getElementById("foto-chat");
    if (fotoChat) {
      fotoChat.onerror = () => { fotoChat.src = "img/usuario-camara.png"; };
      fotoChat.src = foto;
    }

    // Depuraci√≥n
    console.log("üì© Mensajes recibidos:", data.mensajes);

    // --- Mejor: no vaciamos toda la lista, solo agregamos los nuevos ---
    const idsExistentes = new Set([...listaMensajes.querySelectorAll("li")].map(li => li.dataset.id));

    // Ordenar por fecha ascendente
    const mensajesOrdenados = Array.isArray(data.mensajes)
      ? [...data.mensajes].sort((a, b) => new Date(a.fecha_envio) - new Date(b.fecha_envio))
      : [];

    mensajesOrdenados.forEach(msg => {
      // üëâ clave alternativa: usa id si existe, si no usa fecha
      const clave = msg.id ? String(msg.id) : String(msg.fecha_envio);

      if (!idsExistentes.has(clave)) {
        const li = document.createElement("li");
        li.dataset.id = clave;

        const fecha = new Date(msg.fecha_envio);
        const hora = isNaN(fecha.getTime())
          ? ""
          : fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const emisorNombre = msg.emisor_nombre || "Usuario";
        const esAudio = (msg.tipo === "audio") ||
                        (typeof msg.contenido === "string" && msg.contenido.endsWith(".webm"));

        let contenidoHTML;
        if (esAudio) {
          let audioURL = msg.contenido || "";
          if (audioURL && !audioURL.startsWith("http")) {
            audioURL = `https://storage.googleapis.com/${BUCKET_NAME}/${audioURL}`;
          }
          contenidoHTML = `
            <div class="contenido">
              <strong>${emisorNombre}:</strong>
              <audio controls src="${audioURL}"></audio>
              <span class="hora">${hora}</span>
            </div>
          `;
        } else {
          const textoSeguro = (msg.contenido ?? "").toString();
          contenidoHTML = `
            <div class="contenido">
              <strong>${emisorNombre}:</strong> ${textoSeguro}
              <span class="hora">${hora}</span>
            </div>
          `;
        }

        li.innerHTML = contenidoHTML;
        li.classList.add(String(msg.emisor_id) === String(data.usuarioActualId) ? "mio" : "otro");

        listaMensajes.appendChild(li);
      }
    });

    // Scroll al √∫ltimo mensaje
    setTimeout(() => {mensajesWrapper.scrollTop = mensajesWrapper.scrollHeight;}, 50);
  } catch (error) {
    console.error("Error al cargar mensajes:", error);
    listaMensajes.innerHTML = "<li>Error de conexi√≥n</li>";
  }
}

// üóëÔ∏è Funci√≥n para borrar el chat actual y volver al Home
async function borrarChatActual() {
    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("id");

    if (!chatId) return;

    const confirmar = confirm("¬øEst√°s seguro de que quieres borrar TODA la conversaci√≥n?");
    if (!confirmar) return;

    try {
        const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
            method: "DELETE",
            credentials: "include"
        });

        const data = await res.json();

        if (data.success) {
            // üöÄ Segundo paso: Redirecci√≥n al Home
            window.location.href = "home.html";
        } else {
            alert("No se pudo borrar el chat: " + (data.mensaje || "Error desconocido"));
        }
    } catch (error) {
        console.error("‚ùå Error en la petici√≥n DELETE:", error);
        alert("Error de conexi√≥n al intentar borrar.");
    }
}

// --- INICIALIZACI√ìN ---
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const chatId = params.get("id");

  if (chatId) {
    cargarMensajes(chatId);
    setInterval(() => cargarMensajes(chatId), 5000); // Actualiza cada 5 segundos
  }
  // üëá A√ëADE ESTO AQU√ç escuchar el boton de eliminar
  const btnBorrarChat = document.getElementById("btn-borrar-chat");
  if (btnBorrarChat) {
    btnBorrarChat.addEventListener("click", borrarChatActual);
  }

  // Enviar con bot√≥n
  btnEnviar.addEventListener("click", async () => {
    const contenido = nuevoMensaje.value.trim();
    if (contenido) {
      const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ contenido })
      });
      const data = await res.json();
      if (data.success) {
        nuevoMensaje.value = "";
        await cargarMensajes(chatId); // üëà refresca inmediatamente
      }
    }
  });

  // Enviar con Enter (Shift+Enter sigue siendo salto de l√≠nea)
  nuevoMensaje.addEventListener("keydown", async (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault(); // evita salto de l√≠nea
      btnEnviar.click();  // dispara el mismo evento que el bot√≥n
    }
  });
});

</script>  
</body>
</html>









































