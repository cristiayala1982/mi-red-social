<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <!-- Aquí van tus estilos CSS -->
  <link rel="stylesheet" href="css/styles.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

  <div class="chat-container">
    <div class="chat-header">
      <img id="foto-chat" src="img/usuario-camara.png" alt="Foto de perfil" class="perfil-img-chat">
      <h2 id="nombre-chat">Cargando...</h2>
    </div>
    <ul id="lista-mensajes" class="chat-messages"></ul>
    <div class="input-container">
      <div class="input-wrapper">
        <textarea id="nuevo-mensaje" rows="1" placeholder="Escribe un mensaje..."></textarea>
        <button id="btn-audio" class="icono-audio" title="Grabar audio">
          <i class="fa fa-microphone"></i>
        </button>
        <div id="grabando-ondas" class="ondas oculto">
          <span></span><span></span><span></span><span></span>
        </div>
      </div>
      <button id="enviar">Enviar</button>
    </div>
  </div>

<script>
// --- CONFIGURACIÓN ---
const API_URL = "https://phonic-odyssey-480319-a4.rj.r.appspot.com";
const BUCKET_NAME = "mi-red-social-imagenes";

// --- ELEMENTOS DEL DOM ---
const listaMensajes = document.getElementById("lista-mensajes");
const btnEnviar = document.getElementById("enviar");
const nuevoMensaje = document.getElementById("nuevo-mensaje");
const btnAudio = document.getElementById("btn-audio");
const ondas = document.getElementById("grabando-ondas");

// --- LÓGICA DE AUDIO ---
let mediaRecorder;
let audioChunks = [];
let grabando = false;

btnAudio.addEventListener("click", async () => {
  if (!grabando) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "mensaje.webm");

        const params = new URLSearchParams(window.location.search);
        const chatId = params.get("id");

        const res = await fetch(`${API_URL}/api/chats/${chatId}/audio`, {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          cargarMensajes(chatId);
        } else {
          alert("❌ No se pudo enviar el audio");
        }

        btnAudio.innerHTML = `<i class="fa fa-microphone"></i>`;
        ondas.classList.add("oculto");
        grabando = false;
      };

      mediaRecorder.start();
      btnAudio.innerHTML = "⏹️";
      ondas.classList.remove("oculto");
      grabando = true;

      setTimeout(() => {
        if (grabando) mediaRecorder.stop();
      }, 30000);

    } catch (err) {
      console.error("❌ Error accediendo al micrófono:", err);
      alert("No se pudo acceder al micrófono");
    }
  } else {
    mediaRecorder.stop();
  }
});

// --- LÓGICA DE MENSAJES ---
async function cargarMensajes(chatId) {
  try {
    const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
      credentials: "include"
    });
    const data = await res.json();

    if (!data.success) {
      listaMensajes.innerHTML = "<li>Error al cargar mensajes</li>";
      return;
    }

    document.getElementById("nombre-chat").textContent = data.nombre;

    const fotoValida = typeof data.fotoPerfil === "string" && data.fotoPerfil.trim() !== "";
    const foto = fotoValida ? `${data.fotoPerfil}?t=${Date.now()}` : "img/usuario-camara.png";

    const fotoChat = document.getElementById("foto-chat");
    if (fotoChat) {
      fotoChat.onerror = () => { fotoChat.src = "img/usuario-camara.png"; };
      fotoChat.src = foto;
    }

    const idsExistentes = new Set([...listaMensajes.querySelectorAll("li")].map(li => li.dataset.id));

    data.mensajes.forEach(msg => {
      if (!idsExistentes.has(String(msg.id))) {
        const li = document.createElement("li");
        li.dataset.id = msg.id;

        const fecha = new Date(msg.fecha_envio);
        const hora = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let contenidoHTML;
        if (msg.tipo === "audio") {
          console.log('¡Mensaje de audio detectado!', msg); // Para depurar
          const audioURL = `https://storage.googleapis.com/${BUCKET_NAME}/${msg.contenido}`;
          contenidoHTML = `
            <div class="contenido">
              <strong>${msg.emisor_nombre}:</strong>
              <audio controls src="${audioURL}"></audio>
              <span class="hora">${hora}</span>
            </div>
          `;
        } else {
          contenidoHTML = `
            <div class="contenido">
              <strong>${msg.emisor_nombre}:</strong> ${msg.contenido}
              <span class="hora">${hora}</span>
            </div>
          `;
        }

        li.innerHTML = contenidoHTML;

        if (String(msg.emisor_id) === String(data.usuarioActualId)) {
          li.classList.add("mio");
        } else {
          li.classList.add("otro");
        }

        listaMensajes.appendChild(li);
      }
    });

    listaMensajes.scrollTop = listaMensajes.scrollHeight;

  } catch (error) {
    console.error("Error al cargar mensajes:", error);
    listaMensajes.innerHTML = "<li>Error de conexión</li>";
  }
}

// --- INICIALIZACIÓN ---
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const chatId = params.get("id");

  if (chatId) {
    cargarMensajes(chatId);
    setInterval(() => cargarMensajes(chatId), 5000); // Actualiza cada 5 segundos
  }

  btnEnviar.addEventListener("click", async () => {
    const contenido = nuevoMensaje.value.trim();
    if (contenido) {
      const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ contenido })
      });
      const data = await res.json();
      if (data.success) {
        nuevoMensaje.value = "";
        cargarMensajes(chatId);
      }
    }
  });
});

</script>

</body>
</html>


















