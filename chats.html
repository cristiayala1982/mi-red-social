<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <title>Home</title>
  <link rel="stylesheet" href="home-css/navbar.css">
  <link rel="stylesheet" href="home-css/panelChats.css">
  <link rel="stylesheet" href="home-css/modal-listaamigos.css">
  <link rel="stylesheet" href="home-css/chats.css">
  
  
</head>

<body>
<nav class="app-navbar">
  <div class="app-navbar-logo">
    <a href="home.html">
      <img src="img/icono home.webp" alt="Inicio" width="40" height="40">
    </a>
    <span id="bienvenida" class="bienvenida-texto"></span>
  </div>

  <!-- Buscador -->
  <form id="form-busqueda" class="buscador-usuarios">
    <span class="icono-lupa">üîç</span>
    <input type="text" id="input-busqueda" placeholder="Buscar usuario..." autocomplete="off">
    <ul id="resultados-busqueda" class="resultados-autocompletado"></ul>
  </form>
 <!-- √çconos de mensaje y amigos -->
<div class="nav-icons">
  <button id="btn-amigos" class="icono-btn">üë•</button>
  <button id="btn-mensajes" class="icono-btn" style="position:relative;">
    üí¨
    <span id="badge-mensajes" class="badge" style="display:none;"></span>
  </button>
</div>

  <!-- Foto de perfil con men√∫ -->
  <div class="perfil-menu">
    <img id="nav-foto-perfil" src="img/usuario-camara.png" alt="Perfil" class="perfil-icono-nav">
    <ul class="dropdown-menu">
      <li><a href="miPerfil.html">Mi perfil</a></li>
      <li><a href="#">Cerrar sesi√≥n</a></li>
    </ul>
  </div>
</nav>
<!-- Contenedor principal de la app -->
<div class="app-container">
  <!-- MODAL AMIGOS -->
<div id="modal-amigos" class="modal-amigos">
  <div class="modal-contenido">
    <div class="modal-header">
      <h2>Lista de Amigos</h2>
      <span id="cerrar-modal-amigos" class="cerrar-modal">&times;</span>
    </div>
    <div class="modal-body">
      <ul id="lista-amigos" class="lista-amigos"></ul>
    </div>
  </div>
</div>

 <!-- Panel lateral de chats (oculto al inicio) -->
  <div id="panel-chats" class="panel oculto">
    <span class="cerrar-panel">&times;</span>
    <h2>Mis chats</h2>
    <ul id="lista-chats"></ul>
  </div>
<main class="chat-container">
  <!-- Encabezado del chat -->
  <div class="encabezado-chat">
    <img src="img/usuario-camara.png" alt="Foto" class="foto-chat" id="foto-chat">
    <span class="nombre-chat" id="nombre-chat"></span>
    <button id="btn-borrar-chat" title="Eliminar este chat">üóëÔ∏è</button>
  </div>
  <!--NOTIFICACION DE BORRAR MENSAJE-->
  <div id="notificacion-chat" class="notificacion oculto"></div>

  <!-- Cuadro de mensajes con scroll independiente -->
  <div class="mensajes-wrapper">
    <div class="mensajes-centro">
      <ul id="lista-mensajes"></ul>
    </div>
  </div>

  <!-- Input de mensaje -->
<div class="input-container">
  <div class="input-wrapper">
    <textarea id="nuevo-mensaje" rows="1" placeholder="Escribe un mensaje..."></textarea>
    <!-- üé§ Bot√≥n micr√≥fono / stop -->
    <button id="btn-audio" class="icono-audio" title="Grabar audio">
      <i class="fa fa-microphone"></i>
    </button>
    <!-- üîä Ondas de grabaci√≥n -->
    <div id="grabando-ondas" class="ondas oculto">
      <span></span><span></span><span></span><span></span>
    </div>
  </div>
  <button id="enviar">Enviar</button>
</div>
</main>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Scripts principales en orden -->
    
    <script type="module" src="HOME_JS/navbar.js"></script>
    <script type="module" src="HOME_JS/buscador.js"></script>
    <script type="module" src="HOME_JS/cerrarSesion.js"></script>
    <script type="module" src="HOME_JS/listaAmigosYchats.js"></script>
    <script>
alert('prueba de si fuciona el codigo 08:11');
// --- CONFIGURACI√ìN ---
const API_URL = "https://phonic-odyssey-480319-a4.rj.r.appspot.com";
const BUCKET_NAME = "mi-red-social-imagenes"; // Aseg√∫rate de que este sea el nombre correcto de tu bucket

// --- ELEMENTOS DEL DOM ---
const listaMensajes = document.getElementById("lista-mensajes");
const btnEnviar = document.getElementById("enviar");
const nuevoMensaje = document.getElementById("nuevo-mensaje");
const btnAudio = document.getElementById("btn-audio");
const ondas = document.getElementById("grabando-ondas");

// --- L√ìGICA DE AUDIO ---
let mediaRecorder;
let audioChunks = [];
let grabando = false;

btnAudio.addEventListener("click", async () => {
  if (!grabando) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "mensaje.webm");

        const params = new URLSearchParams(window.location.search);
        const chatId = params.get("id");

        const res = await fetch(`${API_URL}/api/chats/${chatId}/audio`, {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          cargarMensajes(chatId);
        } else {
          alert("‚ùå No se pudo enviar el audio");
        }

        btnAudio.innerHTML = `<i class="fa fa-microphone"></i>`;
        ondas.classList.add("oculto");
        grabando = false;
      };

      mediaRecorder.start();
      btnAudio.innerHTML = "‚èπÔ∏è";
      ondas.classList.remove("oculto");
      grabando = true;

      setTimeout(() => {
        if (grabando) mediaRecorder.stop();
      }, 30000);

    } catch (err) {
      console.error("‚ùå Error accediendo al micr√≥fono:", err);
      alert("No se pudo acceder al micr√≥fono");
    }
  } else {
    mediaRecorder.stop();
  }
});

// --- L√ìGICA DE MENSAJES (corregida para audio) ---
async function cargarMensajes(chatId) {
  try {
    const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
      credentials: "include"
    });
    const data = await res.json();

    if (!data.success) {
      listaMensajes.innerHTML = "<li>Error al cargar mensajes</li>";
      return;
    }

    document.getElementById("nombre-chat").textContent = data.nombre;

    const fotoValida = typeof data.fotoPerfil === "string" && data.fotoPerfil.trim() !== "";
    const foto = fotoValida ? `${data.fotoPerfil}?t=${Date.now()}` : "img/usuario-camara.png";

    const fotoChat = document.getElementById("foto-chat");
    if (fotoChat) {
      fotoChat.onerror = () => { fotoChat.src = "img/usuario-camara.png"; };
      fotoChat.src = foto;
    }

    const idsExistentes = new Set([...listaMensajes.querySelectorAll("li")].map(li => li.dataset.id));

    data.mensajes.forEach(msg => {
      if (!idsExistentes.has(String(msg.id))) {
        const li = document.createElement("li");
        li.dataset.id = msg.id;

        const fecha = new Date(msg.fecha_envio);
        const hora = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let contenidoHTML;
        if (msg.tipo === "audio") {
          console.log("¬°Mensaje de audio detectado!", msg); // Para depurar
          contenidoHTML = `
            <div class="contenido">
              <strong>${msg.emisor_nombre}:</strong>
              <audio controls src="${msg.contenido}"></audio>
              <span class="hora">${hora}</span>
            </div>
          `;
        } else {
          contenidoHTML = `
            <div class="contenido">
              <strong>${msg.emisor_nombre}:</strong> ${msg.contenido}
              <span class="hora">${hora}</span>
            </div>
          `;
        }

        li.innerHTML = contenidoHTML;

        if (String(msg.emisor_id) === String(data.usuarioActualId)) {
          li.classList.add("mio");
        } else {
          li.classList.add("otro");
        }

        listaMensajes.appendChild(li);
      }
    });

    listaMensajes.scrollTop = listaMensajes.scrollHeight;

  } catch (error) {
    console.error("Error al cargar mensajes:", error);
    listaMensajes.innerHTML = "<li>Error de conexi√≥n</li>";
  }
}


// --- INICIALIZACI√ìN ---
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const chatId = params.get("id");

  if (chatId) {
    cargarMensajes(chatId);
    setInterval(() => cargarMensajes(chatId), 5000); // Actualiza cada 5 segundos
  }

  btnEnviar.addEventListener("click", async () => {
    const contenido = nuevoMensaje.value.trim();
    if (contenido) {
      const res = await fetch(`${API_URL}/api/chats/${chatId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ contenido })
      });
      const data = await res.json();
      if (data.success) {
        nuevoMensaje.value = "";
        cargarMensajes(chatId);
      }
    }
  });
});

</script>  
</body>
</html>
























